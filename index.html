<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOL 내전 관리 사이트</title>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { 
  getFirestore, collection, addDoc, doc, writeBatch, getDocs, query, orderBy, deleteDoc 
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Firebase 설정
const firebaseConfig = {
  apiKey: "AIzaSyBrdOkfNc4YBDc3m2ACqQhvIXQnzPOJzcw",
  authDomain: "lol123-cad3e.firebaseapp.com",
  projectId: "lol123-cad3e",
  storageBucket: "lol123-cad3e.firebasestorage.app",
  messagingSenderId: "22166999425",
  appId: "1:22166999425:web:7f31c380eacc0406d4d880"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
window.firestoreDB = db;

// 글로벌 DataTable 변수
window.userTable = null;
let idCounter = 0;

// 테스트 유저 생성
async function createTestUser() {
  try {
    const usersSnapshot = await getDocs(collection(db, "users"));
    if (usersSnapshot.empty) {
      await addDoc(collection(db, "users"), {
        userId: 1,
        userName: "테스트유저",
        rating: 1000,
        tier: "브론즈 5",
        mainLane: "-",
        subLane: "-",
        win: 0,
        loss: 0,
        matchNumber: 0,
        winRate: "0%",
        lastPlayDateSince: "-"
      });
      console.log("✅ users 컬렉션과 문서 생성 완료");
    }
  } catch(e) {
    console.error("❌ createTestUser error", e);
  }
}

// Firestore 저장 함수
async function saveUsersToFirestore() {
  if (!window.userTable) return console.error("userTable이 초기화되지 않았습니다.");
  try {
    const users = window.userTable.rows().data().toArray();
    const batch = writeBatch(db);
    users.forEach(u => {
      u.matchNumber = (u.win||0) + (u.loss||0);
      u.winRate = u.matchNumber===0 ? '0%' : Math.round((u.win||0)/u.matchNumber*100)+'%';
      u.tier = u.tier || '브론즈';
      u.userId = u.userId || (++idCounter);
      const ref = doc(db, 'users', String(u.userId));
      batch.set(ref, u);
    });
    await batch.commit();
    console.log("✅ Firestore 저장 성공");
  } catch(e) {
    console.error("❌ saveUsersToFirestore error", e);
  }
}

// 문서 준비 후 DataTable 초기화
$(document).ready(async function() {
  await createTestUser();

  // DataTable 초기화
  window.userTable = $('#userTable').DataTable({
    paging: false,
    serverSide: false,
    data: [],
    columns: [
      { data: null, render: (d,t,r,m)=> m.row+1 },
      { data: "userName" },
      { data: "tier" },
      { data: "rating" },
      { data: "mainLane" },
      { data: "subLane" },
      { data: "matchNumber" },
      { data: "win" },
      { data: "loss" },
      { data: "winRate" },
      { data: "lastPlayDateSince" },
      { data: null, defaultContent: '<button class="delete-btn">삭제</button>', orderable:false }
    ]
  });

  // 버튼 이벤트
  $('#add-user-btn').click(function(){
    const newId = ++idCounter;
    const newUser = { userId:newId, userName:'이름', rating:1000, mainLane:'-', subLane:'-', win:0, loss:0, matchNumber:0, winRate:'0%', tier:'브론즈', lastPlayDateSince:'-' };
    window.userTable.row.add(newUser).draw(false);
    saveUsersToFirestore();
  });

  $('#userTable tbody').on('click','.delete-btn', async function(){
    if(!confirm('정말 삭제하시겠습니까?')) return;
    window.userTable.row($(this).closest('tr')).remove().draw(false);
    await saveUsersToFirestore();
  });
});
</script>

<style>
:root{--card:#2a2a2a;--accent1:#ffb347;--accent2:#ff8c42;--text:#f0f0f0;--muted:#555}
body{font-family:Segoe UI, Tahoma, Geneva, Verdana,sans-serif;background:#222;margin:0;padding:20px;color:var(--text)}
nav{text-align:center;margin-bottom:30px}
nav button{background:linear-gradient(145deg,var(--accent1),#ffcc80);color:#121212;border:none;padding:10px 18px;margin:0 5px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 6px rgba(0,0,0,.5);transition:all .2s}
nav button:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1));transform:translateY(-2px)}
.section{background:var(--card);padding:25px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.5);margin-bottom:40px}
table.dataTable, #log-result table, #match-result table{width:100%;border-collapse:collapse;color:var(--text)}
table.dataTable th, #log-result th, #match-result th{background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212;font-weight:600}
table.dataTable td, table.dataTable th, #log-result td, #match-result td{padding:10px;text-align:center;position:relative;border:1px solid #444}
table.dataTable tbody tr:hover td{background:#ffcc80 !important;color:#121212 !important;transition:background .12s}
tr.editing td{background:#ffd8a8 !important}
.delete-btn{color:#121212;background:linear-gradient(145deg,var(--accent1),var(--accent2));border:none;padding:4px 8px;border-radius:6px;cursor:pointer;display:none;box-shadow:0 2px 4px rgba(0,0,0,.4);transition:all .2s}
.delete-btn:hover{background:linear-gradient(145deg,var(--accent2),var(--accent1))}
.fixed-btn{position:fixed;bottom:20px;z-index:1000;padding:12px 20px;border:none;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 5px 10px rgba(0,0,0,.5);color:#121212;background:linear-gradient(145deg,var(--accent1),#ffcc80);transition:all .2s}
.fixed-btn:hover{transform:translateY(-2px);background:linear-gradient(145deg,var(--accent2),var(--accent1))}
#start-edit-btn,#edit-users-btn,#btn-add-user-bottom{right:20px}
#btn-add-user-bottom{right:200px;display:none}
#btn-match{right:20px;display:none}
#btn-log-save{right:20px; display:none}
.team-container select, select.match-p, select.log-p{padding:10px;font-size:16px;border-radius:6px;border:1px solid var(--muted);background:var(--card);color:var(--text);width:100%}
input[type=text], input[type=number], input[type=date]{padding:6px 8px;border-radius:6px;border:1px solid var(--muted);background:var(--card);color:var(--text)}
.dataTables_filter{margin-bottom:15px !important}
#match-team,#log-players{display:grid;grid-template-columns:repeat(2,1fr);gap:20px;max-width:640px;margin:0 auto}
#log-players-header{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:640px;margin:0 auto 10px}
#log-players-header div{text-align:center;font-weight:700;color:var(--text)}
#log-result{max-width:100%;margin:20px 0 0}
#log-result table td{text-align:left;padding:8px}
#log-result td:last-child { width: 80px; max-width: 80px; word-wrap: break-word; }
#log-result thead th.date-col { width:150px; max-width:150px; }
.log-record-delete{padding:4px 8px;border-radius:6px;border:none;cursor:pointer;background:linear-gradient(145deg,var(--accent1),var(--accent2));color:#121212;font-weight:600}
.winner-pill{background:#87CEFA;padding:2px 6px;margin:1px;border-radius:4px;display:inline-block;color:#121212}
.loser-pill{background:#F08080;padding:2px 6px;margin:1px;border-radius:4px;display:inline-block;color:#121212}
.select2-container--default .select2-selection--single{background:var(--card);border:1px solid var(--muted);border-radius:6px;height:44px;box-sizing:border-box}
.select2-container--default .select2-selection--single .select2-selection__rendered{line-height:42px;color:var(--text);padding-left:8px}
.select2-dropdown,.select2-container--default .select2-results > .select2-results__options{background:var(--card);color:var(--text)}
.select2-results__option[aria-selected="true"],.select2-results__option--highlighted[aria-selected]{background:#ffcc80;color:#121212}
@media (max-width:700px){#match-team,#log-players,#log-players-header{max-width:100%;grid-template-columns:1fr}#btn-add-user-bottom{right:140px}}
</style>
</head>
<body>

<nav>
  <button id="menu-dashboard">대시보드</button>
  <button id="menu-match">자동 팀 생성</button>
  <button id="menu-log">내전 기록</button>
</nav>

<section id="section-dashboard" class="section">
  <table id="userTable" class="display">
    <thead>
      <tr>
        <th>No</th><th>이름</th><th>티어</th><th>레이팅</th><th>주라인</th><th>부라인</th>
        <th>판수</th><th>승리</th><th>패배</th><th>승률</th><th>최근 경기</th><th>메뉴</th>
      </tr>
    </thead>
  </table>
</section>

<section id="section-match" class="section" style="display:none;">
  <div id="match-team"></div>
  <br>
  <button id="btn-match" class="fixed-btn">매칭하기</button>

  <div id="match-result">
    <h3>팀 매치 결과</h3>
    <table>
      <thead><tr><th>블루팀</th><th>레드팀</th></tr></thead>
      <tbody><tr><td colspan="2" style="text-align:center">매칭하기 버튼을 눌러 결과 확인</td></tr></tbody>
    </table>
  </div>
</section>

<section id="section-log" class="section" style="display:none;">
  <div id="log-players-header">
    <div>승리팀</div>
    <div>패배팀</div>
  </div>

  <div id="log-players"></div>
  <br>

  <div id="log-result">
    <h3>최근 기록</h3>
    <table>
      <thead><tr>
        <th class="date-col">날짜</th>
        <th>승리팀 멤버</th>
        <th>패배팀 멤버</th>
        <th>메뉴</th>
      </tr></thead>
      <tbody><tr><td colspan="4" style="text-align:center">저장된 기록이 없습니다.</td></tr></tbody>
    </table>
  </div>
</section>

<button id="start-edit-btn" class="fixed-btn">유저 수정</button>
<button id="edit-users-btn" class="fixed-btn" style="display:none">유저 수정 완료</button>
<button id="btn-add-user-bottom" class="fixed-btn" style="display:none">유저 추가</button>
<button id="btn-log-save" class="fixed-btn">기록 저장</button>

<script>
let editable = false;
let idCounter = 0;
const allowedUsers = ['admin'];
let currentUser = prompt("사용자 이름을 입력하세요:") || '';

if(!allowedUsers.includes(currentUser)){
  $('#menu-log').hide();
  $('#start-edit-btn').hide();
}

function updateUserEditButtonVisibility(){
  if($('#section-dashboard').is(':visible')){
    if(editable){
      $('#start-edit-btn').hide();
      $('#edit-users-btn').show();
      $('#btn-add-user-bottom').show();
    } else if(allowedUsers.includes(currentUser)){
      $('#start-edit-btn').show();
      $('#edit-users-btn').hide();
      $('#btn-add-user-bottom').hide();
    }
  } else { 
    $('#start-edit-btn,#edit-users-btn,#btn-add-user-bottom').hide(); 
  }

  $('#btn-match').toggle($('#section-match').is(':visible'));
  $('#btn-log-save').toggle($('#section-log').is(':visible') && allowedUsers.includes(currentUser));
}

$('nav button').click(function(){
  $('.section').hide();
  if(this.id==='menu-dashboard') $('#section-dashboard').show();
  if(this.id==='menu-match'){ 
    $('#section-match').show();
    initPlayers();
  }
  if(this.id==='menu-log'){ 
    $('#section-log').show(); 
    initPlayers(); 
    loadLogs(); 
  }
  updateUserEditButtonVisibility();
});

var userTable = $('#userTable').DataTable({
  paging:false, serverSide:false, data:[], autoWidth:false,
  columns:[
    {data:null, render:(d,t,r,m)=> m.row+1},
    {data:"userName"}, {data:"tier"}, {data:"rating"}, {data:"mainLane"}, {data:"subLane"},
    {data:"matchNumber"}, {data:"win"}, {data:"loss"}, {data:"winRate"}, {data:"lastPlayDateSince"},
    {data:null, defaultContent:'<button class="delete-btn">삭제</button>', orderable:false}
  ],
  columnDefs:[{targets:1,width:'17%',className:'dt-left'},{targets:4,width:'7%'},{targets:5,width:'7%'},{targets:10,width:'8%'}]
});

userTable.on('draw', function(){
  applyTierColors();
  updateDeleteButtons();
});

function calculateWinRate(win, match){ return match===0 ? '0%' : Math.round((win/match)*100)+'%'; }

function getTierByRating(r){
  if(!r) return'아이언';
  r=+r;
  // 등급 판정
  if(r>=3000) return'챌린저'; if(r>=2900) return'그마'; if(r>=2800) return'마스터 3'; if(r>=2700) return'마스터 2'; if(r>=2600) return'마스터 1'; if(r>=2500) return'마스터 0';
  if(r>=2450) return'다이아 1'; if(r>=2400) return'다이아 2'; if(r>=2350) return'다이아 3'; if(r>=2300) return'다이아 4'; if(r>=2250) return'다이아 5';
  if(r>=2200) return'에메랄드 1'; if(r>=2150) return'에메랄드 2'; if(r>=2100) return'에메랄드 3'; if(r>=2050) return'에메랄드 4'; if(r>=2000) return'에메랄드 5';
  if(r>=1950) return'플레티넘 1'; if(r>=1900) return'플레티넘 2'; if(r>=1850) return'플레티넘 3'; if(r>=1800) return'플레티넘 4'; if(r>=1750) return'플레티넘 5';
  if(r>=1700) return'골드 1'; if(r>=1650) return'골드 2'; if(r>=1600) return'골드 3'; if(r>=1550) return'골드 4'; if(r>=1500) return'골드 5';
  if(r>=1450) return'실버 1'; if(r>=1400) return'실버 2'; if(r>=1350) return'실버 3'; if(r>=1300) return'실버 4'; if(r>=1250) return'실버 5';
  if(r>=1200) return'브론즈 1'; if(r>=1150) return'브론즈 2'; if(r>=1100) return'브론즈 3'; if(r>=1050) return'브론즈 4'; if(r>=1000) return'브론즈 5';
  return'아이언';
}

function applyTierColors(){
  $('#userTable tbody tr').each(function(){
    let $td = $(this).find('td').eq(2), tier = $td.text().trim(), bg='#2a2a2a', color='#f0f0f0';
    if(tier.includes('아이언')) { bg='#fff'; color='#121212'; }
    else if(tier.includes('브론즈')) { bg='#DEB84F'; color='#121212'; }
    else if(tier.includes('실버')) { bg='#BDBDBD'; color='#121212'; }
    else if(tier.includes('골드')) { bg='#FAED7D'; color='#121212'; }
    else if(tier.includes('플레티넘')) { bg='#ABF200'; color='#121212'; }
    else if(tier.includes('에메랄드')) { bg='#2FED28'; color='#121212'; }
    else if(tier.includes('다이아')) { bg='#00D8FF'; color='#121212'; }
    else if(tier.includes('마스터')) { bg='#C98AFF'; color='#121212'; }
    else if(tier.includes('그마')) { bg='#FF3636'; color='#121212'; }
    else if(tier.includes('챌린저')) { bg='linear-gradient(to right,#ffd700,#1e90ff)'; color='#121212'; }
    $td.css(tier.includes('챌린저') ? {'background':bg,'color':color,'font-weight':'600'} : {'background-color':bg,'color':color,'font-weight':'600'});
  });
}

async function saveUsersToLocalStorage() {
  try {
    const users = userTable.rows().data().toArray();
    const batch = writeBatch(window.firestoreDB);

    users.forEach(u => {
      u.matchNumber = (u.win||0) + (u.loss||0);
      u.winRate = calculateWinRate(u.win||0, u.matchNumber);
      u.tier = getTierByRating(u.rating||0);
      u.userId = u.userId || (++idCounter);

      const ref = doc(window.firestoreDB, 'users', String(u.userId));
      batch.set(ref, u);  // Firestore에 저장
    });

    await batch.commit();
    console.log("✅ Firestore 저장 성공");
  } catch (e) {
    console.error("❌ save users error", e);
  }
}

$('#btn-add-user-bottom').off('click').on('click', function(){
  let newId = ++idCounter;
  let newUser = { userId:newId, userName:'이름', rating:1000, mainLane:'-', subLane:'-', win:0, loss:0, lastPlayDateSince:'-' };
  newUser.matchNumber = 0; newUser.winRate = calculateWinRate(0,0); newUser.tier = getTierByRating(newUser.rating);
  userTable.row.add(newUser).draw(false);
  applyTierColors();
  updateDeleteButtons();
  saveUsersToLocalStorage();
});

$('#start-edit-btn').off('click').on('click', function(){ editable=true; updateUserEditButtonVisibility(); updateDeleteButtons(); });
$('#edit-users-btn').off('click').on('click', function(){ editable=false; saveUsersToLocalStorage(); updateUserEditButtonVisibility(); updateDeleteButtons(); });

function updateDeleteButtons(){ $('#userTable tbody tr .delete-btn').toggle(editable); }

$('#userTable tbody').off('click', '.delete-btn').on('click','.delete-btn', function(){
  if(!editable || !confirm('정말 삭제하시겠습니까?')) return;
  userTable.row($(this).closest('tr')).remove().draw(false);
  saveUsersToLocalStorage();
});

$('#userTable').off('click','td').on('click','td', function(){
  if(!editable) return;
  let cell = userTable.cell(this);
  if(!cell.index()) return;
  let colIdx = cell.index().column;
  if([0,2,6,9,11].includes(colIdx)) return;
  let orig = cell.data();
  let $input = $('<input>').val(orig);
  if([3,7,8].includes(colIdx)) $input.attr('type','number').attr('min',0);
  $(this).html($input); $(this).closest('tr').addClass('editing'); $input.focus();
  function finish(){
    let val = $input.val();
    if([3,7,8].includes(colIdx)){ val = val===''?0:Number(val); if(isNaN(val)) val=0; }
    cell.data(val).draw(false); $(cell.node()).closest('tr').removeClass('editing');
    updateStatsIfNeeded(colIdx, cell.index().row);
  }
  $input.on('blur', finish).on('keydown', e=>{ if(e.key==='Enter') finish(); if(e.key==='Escape'){ cell.data(orig).draw(false); $(cell.node()).closest('tr').removeClass('editing'); }});
});

function updateStatsIfNeeded(colIdx,rowIdx){
  let data=userTable.row(rowIdx).data();
  data.win=parseInt(data.win)||0; data.loss=parseInt(data.loss)||0;
  data.matchNumber=data.win+data.loss; data.winRate=calculateWinRate(data.win,data.matchNumber);
  if(colIdx===3) data.tier=getTierByRating(parseInt(data.rating)||0);
  userTable.row(rowIdx).data(data).invalidate().draw(false);
  updateDeleteButtons(); applyTierColors();
}

function buildSelects(containerId,className,count){
  const $cont=$('#'+containerId);
  $cont.empty();
  for(let i=1;i<=count;i++) $cont.append(`<select class="${className}" id="${containerId}-${i}"></select>`);
}

function refreshSelectOptions(selector){
  let users=userTable.rows().data().toArray();
  let selected=$(selector).map(function(){ return $(this).val(); }).get().filter(v=>v).map(String);
  let selectedSet=new Set(selected);
  $(selector).each(function(){
    let sel=$(this), curVal=sel.val();
    if(sel.hasClass('select2-hidden-accessible')) sel.select2('destroy');
    sel.empty().append('<option value=""></option>');
    users.forEach(u=>{ if(!selectedSet.has(String(u.userId))||String(u.userId)===String(curVal)) sel.append($('<option>').val(u.userId).text(u.userName)); });
    sel.val(curVal||'').select2({placeholder:'선수 선택',width:'100%',allowClear:true});
  });
}

function initPlayers(){
  if($('#match-team').children().length===0) buildSelects('match-team','match-p',10);
  if($('#log-players').children().length===0) buildSelects('log-players','log-p',10);
  refreshSelectOptions('.match-p');
  refreshSelectOptions('.log-p');
  $('.match-p').off('change.unique').on('change.unique', ()=>refreshSelectOptions('.match-p'));
  $('.log-p').off('change.unique').on('change.unique', ()=>refreshSelectOptions('.log-p'));
}

function generateBalancedTeams(selectedUsers){
  let bestDiff=Infinity, bestTeams=null;
  function combinations(arr,k){ let res=[]; (function c(s,p){ if(p.length===k){res.push(p.slice());return;} for(let i=s;i<arr.length;i++){p.push(arr[i]); c(i+1,p); p.pop();}})(0,[]); return res; }
  let comb = combinations(selectedUsers,5);
  comb.forEach(teamA=>{
    let teamB = selectedUsers.filter(u=>!teamA.includes(u));
    let sumA = teamA.reduce((s,u)=>s+ (parseInt(u.rating||0)),0), sumB = teamB.reduce((s,u)=>s+ (parseInt(u.rating||0)),0);
    let avgA=Math.round(sumA/5), avgB=Math.round(sumB/5), diff=Math.abs(avgA-avgB);
    if(diff < bestDiff){ bestDiff=diff; bestTeams={teamA:teamA.slice(),teamB:teamB.slice(),avgA,avgB}; }
  });
  return bestTeams;
}
$('#btn-match').off('click').on('click', function(){
  let selected = $('.match-p').map(function(){ return $(this).val(); }).get().filter(v=>v);
  if(selected.length!==10){ alert('10명을 모두 선택해주세요'); return; }
  let users = userTable.rows().data().toArray();
  let selectedUsers = selected.map(id => users.find(u=>String(u.userId)===String(id)));
  if(selectedUsers.some(u=>!u)){ alert('선택한 유저 중 데이터 누락이 있습니다.'); return; }
  let teams = generateBalancedTeams(selectedUsers);
  if(!teams){ alert('팀을 생성할 수 없습니다.'); return; }
  let rows=''; for(let i=0;i<5;i++){ rows += `<tr><td>${teams.teamA[i]?.userName||''}</td><td>${teams.teamB[i]?.userName||''}</td></tr>`; }
  rows += `<tr><td>평균 레이팅: ${teams.avgA}</td><td>평균 레이팅: ${teams.avgB}</td></tr>`;
  $('#match-result tbody').html(rows);
});

function getWinnersLosers(players){
  let winners=[], losers=[];
  players.forEach((p,i)=> i%2===0 ? winners.push(p) : losers.push(p));
  while(winners.length<5) winners.push('');
  while(losers.length<5) losers.push('');
  return {winners, losers};
}

function resolveName(val){
  if(!val) return '(미선택)';
  let u = userTable.rows().data().toArray().find(u=>String(u.userId)===String(val) || u.userName===val);
  return u ? u.userName : val;
}

function getMenuForVal(val){
  if(!val) return `<div style="color:#777;margin-bottom:6px">(미선택)</div>`;
  let user = userTable.rows().data().toArray().find(u=>String(u.userId)===String(val)||u.userName===val);
  return user ? `<div style="margin-bottom:6px"><button class="delete-btn log-delete" data-userid="${user.userId}">삭제</button></div>` 
              : `<div style="color:#777;margin-bottom:6px">(대시보드 없음)</div>`;
}

$('#btn-log-save').off('click').on('click', async function(){
  if(!allowedUsers.includes(currentUser)) return alert('권한이 없습니다');
  
  const date = new Date().toISOString().slice(0,10);
  const players = $('.log-p').map((_,el)=>$(el).val()||'').get();
  const {winners, losers} = getWinnersLosers(players);

  if(players.filter(v=>v!=='').length!==10 && !confirm('선수가 모두 선택되지 않았습니다. 계속 저장하시겠습니까?')) return;

  let users = userTable.rows().data().toArray();
  winners.forEach(id=>{ let u=users.find(u=>String(u.userId)===String(id)); if(u){ u.rating=(+u.rating||0)+10; u.win=(+u.win||0)+1; }});
  losers.forEach(id=>{ let u=users.find(u=>String(u.userId)===String(id)); if(u){ u.rating=(+u.rating||0)-10; u.loss=(+u.loss||0)+1; if(u.loss<0) u.loss=0; }});

  userTable.rows().invalidate().draw(false);
  await saveUsersToLocalStorage();

  try {
    await addDoc(collection(window.firestoreDB, 'matchLogs'), { date, winners, losers });
    alert('기록이 저장되었습니다.');
    loadLogs();
  } catch(e) {
    console.error('save log error', e);
    alert('기록 저장 중 오류가 발생했습니다.');
  }
});

async function loadLogs(){
  try {
    const q = query(collection(window.firestoreDB, 'matchLogs'), orderBy('date', 'desc'));
    const snap = await getDocs(q);
    const logs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if(!logs.length) return $('#log-result tbody').html('<tr><td colspan="4" style="text-align:center">저장된 기록이 없습니다.</td></tr>');

    const rows = logs.map((lg,i)=>{
      const {winners, losers} = lg;
      const winnersHTML = winners.map(resolveName).map(n=>`<span class="winner-pill">${n}</span>`).join(' ');
      const losersHTML  = losers.map(resolveName).map(n=>`<span class="loser-pill">${n}</span>`).join(' ');
      const recordDeleteBtn = `<div style="margin-bottom:6px"><button class="log-record-delete" data-log-id="${lg.id}">기록 삭제</button></div>`;
      const perUserMenus = winners.concat(losers).map(getMenuForVal).join('');
      return `<tr><td style="vertical-align:top">${lg.date||''}</td><td>${winnersHTML}</td><td>${losersHTML}</td><td>${recordDeleteBtn+perUserMenus}</td></tr>`;
    }).join('');

    $('#log-result tbody').html(rows);

    $('#log-result').off('click', '.log-record-delete').on('click', '.log-record-delete', async function(){
      if(!allowedUsers.includes(currentUser)) return alert('권한이 없습니다');
      if(!confirm('이 기록을 삭제하시겠습니까?')) return;
      const logId = $(this).data('log-id');
      try {
        await deleteDoc(doc(window.firestoreDB, 'matchLogs', logId));
        loadLogs();
      } catch(e) {
        console.error('delete log error', e);
        alert('기록 삭제 중 오류가 발생했습니다.');
      }
    });

    $('#log-result').off('click', '.log-delete').on('click', '.log-delete', async function(){
      const uid = $(this).data('userid');
      if(!allowedUsers.includes(currentUser)) return alert('권한이 없습니다');
      if(!editable) return alert('편집 모드에서만 삭제 가능합니다.');
      if(confirm('대시보드에서 해당 유저를 삭제하시겠습니까?')){
        userTable.rows((idx,data)=>String(data.userId)===String(uid)).remove().draw(false);
        await saveUsersToLocalStorage();
        loadLogs();
      }
    });
  } catch(e) {
    console.error('load logs error', e);
  }
}

$(document).ready(function(){
  updateUserEditButtonVisibility();
  $('#btn-log-save').hide();
});
</script>

</body>
</html>

